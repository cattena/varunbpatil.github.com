<html>
<head>
    <meta charset="utf-8"/>

    <!-- TO Fancy SEARCH ENGINE -->
    <title>Varun B Patil | Custom kernel in Ubuntu (also generate .deb package)</title>
    <meta name="description" content="Varun B Patil's blog"/>

    <!-- TO FANCY GOOGLE -->
    <meta itemprop="name" content="Varun B Patil's blog"/>
    <meta itemprop="description" content="Varun B Patil blog"/>

    <!-- TO FANCY FACEBOOK -->
    <meta property="og:title" content="Varun B Patil's blog" />
    <meta property="og:type" content="blog" />
    <meta property="og:url" content="http://varunbpatil.github.com/" />
    <meta property="og:site_name" content="Varun B Patil's blog" />

    <meta name="keywords" content="Varun B Patil's blog"/>
    <meta name="robots" content="noodp" />

    <link rel="stylesheet" media="all" href="/style.css"/>
    <link rel="stylesheet" media="all" href="/style_accordion.css"/>
    <link rel="shortcut icon" href="/favicon.ico"/>

    <link href='http://fonts.googleapis.com/css?family=Quantico' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=PT+Sans+Narrow' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Trade+Winds' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Autour+One' rel='stylesheet' type='text/css'>


    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    


  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-32267446-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>






    <!--jQuery-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="../js/custom.js"></script>
    <script type="text/javascript" src="../js/smoothscroll.js"></script>

</head>
<body>

    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter21595372 = new Ya.Metrika({id:21595372,
                        webvisor:true,
                        clickmap:true,
                        trackLinks:true,
                        accurateTrackBounce:true,
                        trackHash:true});
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
    </script>
    <!-- /Yandex.Metrika counter -->

    <div id="wrapper">
        <div style="width:100%;position:fixed;z-index:99;box-shadow:0px 5px 5px #888888;">
        <header id="header">
            <div class="inner">
                <a href="/"><h1 id="site-name">Varun B Patil</h1></a>
                <nav id="navigation">
                <ul class="navigation">
                
                    
                    
                        
                            
                        
                    
                    <li>
                    <span class="">
                    <a class="" href="/index.html" target="">HOME</a>
                    </span>
                    </li>
                
                    
                    
                        
                            
                        
                    
                    <li>
                    <span class="">
                    <a class="" href="/profile/index.html" target="">PROFILE</a>
                    </span>
                    </li>
                
                    
                    
                        
                            
                        
                            
                                
                            
                        
                    
                    <li>
                    <span class="current">
                    <a class="current" href="/blog/index.html" target="">BLOG</a>
                    </span>
                    </li>
                
                    
                    
                        
                            
                        
                            
                        
                            
                        
                    
                    <li>
                    <span class="">
                    <a class="" href="/tag/index.html" target="">TAGS</a>
                    </span>
                    </li>
                
                </ul>
                </nav>
            </div>
        </header>
        </div>

<br />
<br />
<br />
<div id="main">
<article class="post">
    <header class="post-header">
        <h1 class="post-title">Custom kernel in Ubuntu (also generate .deb package)</h1>
    </header><!-- post-title -->
    <div class="post-meta">
        <time class="date" datetime="2012-12-27T00:00:00+05:30">27 December 2012</time>
        <cite><em> &nbsp;&nbsp;by</em> Varun B Patil</cite>

    </div><!-- .post-meta -->
    <p class="postpage"><span style="font-style:italic">tagged under</span>&nbsp;&nbsp;
    
        <a class="tag" href="/tags/linux/">linux</a> &nbsp;
    
        <a class="tag" href="/tags/computers/">computers</a> &nbsp;
    
        <a class="tag" href="/tags/programming/">programming</a> &nbsp;
    
    </p>
    <br />
    <div class="post">
      <p><strong>Updated 20-Jun-2013 : Building kernel deb package</strong> [ <a href="#UPDATE20JUN2013">jump to this</a> ]</p>

<p>This is a final how-to of this great year 2012, where I will show you how to compile a linux kernel and boot it on your linux box(it doesn&#39;t matter which distro you use).</p>

<p>To build the linux kernel, you will need the kernel source first. The best place to get the latest stable and unstable linux kernels is <a href="http://www.kernel.org">www.kernel.org</a>. The latest stable kernel release at the time of this writing is 3.7.1. Go ahead and download the tarball for the latest kernel release(preferrably a stable release). Downloading the kernel source on a decent broadband connection is going to take a while, so sit back and relax. I personally prefer to clone the git repository for the kernel source, so everytime there is a kernel update, I don&#39;t need to download the entire kernel source. There is however no need to download the entire kernel source after an update, even while using a tarball. You can as well get a patch and apply it. Just to keep things simple, let us suppose you downloaded the tarball and extracted it somewhere, say to <strong>~/linux-stable</strong></p>

<p>Now you are ready to start building your new kernel. However, to build a linux kernel, you need to configure the kernel. Basically what this means is that, you need to tell the build system, what the kernel must include within itself and what must be built as modules and what is not neededin the kernel build. For example, you must specify what drivers you need for the hardware on your computer, etc. There are more than a thousand configuration options for the kernel, and it can be a daunting task to specify every single one of them on your own. The solution is to use the configurtion of your current kernel(i.e, the configuration of the kernel that is provided as part of the linux distro you are using). This configuration file should be named <strong>.config</strong> and must be present in the top src directory of the kernel.</p>

<p>So go ahead and copy the present kernel&#39;s config as shown below. The current kernel&#39;s config can be found in /boot with a name starting with config- followed by the kernel version.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ cp /boot/config-* ~/linux-stable/.config
</code></pre></div>
<p>The new kernel may include options not found in your current kernel and thus there may be a few configuration options that you need to still specify.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ cd ~/linux-stable
$ make oldconfig
</code></pre></div>
<p>You will be prompted with quite a few questions that will further configure your new kernel. If you are not sure what to answer to those questions, you can select the default by simply pressing the Enter key for each of the questions. Once the kernel configuration is complete you are ready to actually start compiling the linux kernel.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ make -j`cat /proc/cpuinfo | grep -c processor`
</code></pre></div>
<p>Sit back and relax as the build is going to take a lot of time, especially when you use the configuration of your current kernel, because your current kernel configuration builds drivers for almost every hardware imaginable(even though you wouldn&#39;t need them), because your distro is aimed at a large audience. Using the current kernel&#39;s configuration is the safest way to build the kernel and get it to boot, however, you may try to modify the kernel configuration in ~/linux-stable/.config to suit your needs. The above command builds the kernel image as well as the kernel modules that get loaded dynamically. Now, all that is left is to install the new kernel image and kernel modules and to get the bootloader(ex: GRUB) to recognize and boot the new kernel the next time you boot your computer.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ sudo make modules_install install
</code></pre></div>
<p>The above command installs the kernel image in the /boot directory, generates any initrd(initial ram disk) that is needed by the kernel during boot, generates a map file by the name of System.map(similar to a symbol table for the kernel) and also copies the configuration for the new kernel into the /boot directory(so that you may reuse it later to build another kernel, just as we did). It also modifies the bootloader configuration for you automatically, so that the bootloader(ex: GRUB) recognizes the new kernel. The kernel modules are installed into /lib/modules with the kernel version as the name and are linked to the kernel image. The kernel headers are installed into /usr/src.</p>

<p>That&#39;s it. You have now succesfully compiled and installed a new kernel, albeit without any modifications of your own to the kernel. You can boot into the new kernel by holding down the shift key after the BIOS message during reboot to show the bootmenu of the bootloader where you can select the desired kernel version to boot into(the latest kernel version is selected for boot automatically). After boot, you can verify that you are indeed running the kernel that you just built by running <strong>&quot;$ uname -r&quot;</strong> in a terminal which will show you the kernel version you are currently using.</p>

<p>If you find that you are unable to boot into the new kernel, don&#39;t weep(you might have got some configuration option wrong), there is always backup. You can always boot into the kernel that your distro supplied by selecting it in the bootmenu of the bootloader during boot.</p>

<p>Should you decide that you no longer need a particular kernel version, you can completely get rid of it by deleting the corresponding kernel&#39;s config, vmlinuz, System.map and initrd from the /boot folder and the corresponding kernel modules from /lib/modules and the kernel header from /usr/src. Once you are done deleting these files, all that remains is to update the bootloader by running <strong>&quot;$ sudo update-grub2&quot;</strong>.</p>

<p>Should you decide to rebuild the new kernel from scratch run <strong>&quot;$ make mrproper&quot;</strong>  in ~/linux-stable to clean the kernel configuration and all the files that have already been built and you are ready to start all over again.</p>

<p>Happy hacking :) and happy new year :)</p>

<p><a id="UPDATE20JUN2013"></a></p>

<p><br /><br /><br /></p>

<p><strong>UPDATE : 20-Jun-2013</strong></p>

<h4>Building your custom kernel as a .deb package</h4>

<p>If you find that compiling the kernel is taking too long on your computer, and have another faster, more powerful computer at your disposal, you can build your custom kernel as a .deb package on the faster computer, copy the .deb packages to the other computer and install your custom kernel there. You can even use the same .deb packages to install the custom kernel on other machines.</p>

<p><strong>On the faster machine :</strong></p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ cd ~/linux-stable
$ make-kpkg clean
$ export CONCURRENCY_LEVEL=24 #change according to no. of CPU cores
$ fakeroot make-kpkg --initrd --append-to-version=-custom \
  kernel_image kernel_headers modules_image
</code></pre></div>
<p>The above export and make-kpkg commands can be combined into a single command like below</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ fakeroot make-kpkg -j24 --initrd --append-to-version=-custom \
  kernel_image kernel_headers modules_image
</code></pre></div>
<p>After --append-to-version= you can write any string that helps you identify the kernel, but it must begin with a minus (-) and must not contain whitespace.</p>

<p>After building is complete, you will find two .deb packages in the parent dir of the kernel source tree. Copy them to your other computer where you want to install the custom kernel.</p>

<p><strong>On the slower machine (where you want to install custom kernel) :</strong></p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ sudo dpkg -i linux-image-*
$ sudo dpkg -i linux-headers-*
</code></pre></div>
<p>This step will also make an initrd image as well as modify the grub config for you automatically just as before. All you have to do now is reboot and enjoy your new kernel.</p>

      <br />
      
        <a class="prev_next" style="float: left;" href="/2012/10/01/linux-tricks-2">&laquo;&nbsp;older posts</a>
      
      
        <a class="prev_next" style="float: right;" href="/2013/02/19/cli-task">newer posts&nbsp;&raquo;</a>
      
      <br /><br /><br /><br />
      <b>other articles you might like</b><br />
      
    
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2014/08/19/t440s-touchpad">Configuring Lenovo T440s touchpad in Linux</a>
            </li>
            
        
    

    
    
        
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2014/06/01/truecrypt-alt">Alternatives to Truecrypt on Linux</a>
            </li>
            
        
    

    
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2014/06/01/network-command-line">Connecting to wired/wireless networks via command line</a>
            </li>
            
        
    

    
    
        
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2014/03/21/reverse-tethering">Android reverse USB tethering</a>
            </li>
            
        
    

    
    
        
    

    
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2013/11/18/linux-tricks-3">Linux command line tools and tricks - Part 3</a>
            </li>
            
        
    
        
    
        
    

    
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2013/09/28/dwm">Basic dwm setup in (L)ubuntu</a>
            </li>
            
        
    

    
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2013/09/20/xmonad">Basic Xmonad setup in (L)ubuntu</a>
            </li>
            
        
    

    
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2013/08/19/eom">EOM a.k.a End of Mail a.k.a Emacs + offlineimap + mu4e</a>
            </li>
            
        
    
        
    

    
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2013/08/12/firefox-addon">First attempt at developing a Firefox addon</a>
            </li>
            
        
    

    
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2013/08/05/ncp">Bash script to perform super-fast file transfer using netcat and tar</a>
            </li>
            
        
    

    
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2013/07/06/jekyll-build-fail">Jekyll : Handling Github page build failure and Jekyll plugins on Github</a>
            </li>
            
        
    
        
    
        
    

    
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2013/05/26/emacs-newbie">Emacs newbie cheat sheet -- from a vim convert</a>
            </li>
            
        
    
        
    
        
    
        
    

    
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2013/04/11/ncmpcpp">ncmpcpp : ncurses based music player for Linux</a>
            </li>
            
        
    
        
    

    
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2013/03/02/apps-zip">How to create a custom CWM recovery flash-able android apps zip file in Linux via command line</a>
            </li>
            
        
    
        
    
        
    

    
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2013/02/19/cli-task">Task Warrior - The best CLI task manager for Linux</a>
            </li>
            
        
    
        
    

    
    
        
    
        
    
        
    

    
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2012/10/01/linux-tricks-2">Linux command line tools and tricks - Part 2</a>
            </li>
            
        
    
        
    
        
    

    
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2012/09/19/linux-tricks">Superb Linux command line tools and tricks for Linux geeks</a>
            </li>
            
        
    
        
    
        
    

    
    
        
    

    
    
        
    

    
    
        
    

    
    
        
    

    
    
        
    
        
    

    
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2012/06/06/black-hat-hackers">Black hat Hall Of Fame</a>
            </li>
            
        
    
        
    

    
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2012/06/02/behind-the-scene">Behind the scene</a>
            </li>
            
        
    

    
    
        
    

    
    
        
    
        
    
        
    

    
    
        
    
        
    
        
    

    
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2012/01/10/rsa-tcl">RSA encryption using Tcl</a>
            </li>
            
        
    
        
    

    
    
        
    
        
            <li style="list-style:none;font-size:16px;margin-bottom:-3px;">
                <a href="/2012/01/04/stuxnet">Stuxnet: the greatest, meanest computer virus ever written</a>
            </li>
            
        
    

    </div>
    <br />
    <br />
    <br />


<p style="float: left; margin-top: 4px;">Share this post &rArr;&nbsp;&nbsp;</p>
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style addthis_32x32_style">
<a style="border-bottom:0" class="addthis_button_preferred_1"></a>
<a style="border-bottom:0" class="addthis_button_preferred_2"></a>
<a style="border-bottom:0" class="addthis_button_preferred_3"></a>
<a style="border-bottom:0" class="addthis_button_preferred_4"></a>
<a style="border-bottom:0" class="addthis_button_compact"></a>
<a style="border-bottom:0" class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
<script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-4fd1e13840ac7423"></script>
<!-- AddThis Button END -->


<br />
<br />
<br />
<br />

</article><!-- .post -->
</div>

<div class="fb_comments">
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'varunbpatil'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>





</div>

<br />
<br />
<br />
<footer id="footer" style="clear: both">
    <div class="inner">

        <p class="social" style="margin-top: -10px;">Contact me &nbsp;&rarr;&nbsp;&nbsp;
                <a title="facebook" class="social" href="http://www.facebook.com/varunbpatil" target="_blank"><img src="/PNGs/facebook.png" width="32px" /></a>
                <a title="twitter" class="social" href="http://twitter.com/#!/varunbpatil" target="_blank"><img src="/PNGs/twitter.png" width="32px" /></a>
                <a title="linkedin" class="social" href="https://www.linkedin.com/in/varunbpatil/" target="_blank"><img src="/PNGs/linkedin.png" width="32px" /></a>
                <a title="google+" class="social" href="https://plus.google.com/112161568047512619329/posts" target="_blank"><img src="/PNGs/googleplus.png" width="32px" /></a>
                <a title="github" class="social" href="https://github.com/varunbpatil/" target="_blank"><img src="/PNGs/github.png" width="32px" /></a>
                <a title="gmail" class="social" href="mailto:varun.basavaraj.patil@gmail.com" target="_blank"><img src="/PNGs/gmail.png" width="32px" /></a>
        </p>



        <p class="social" style="margin-bottom: 23px;">Subscribe to my posts &nbsp;&rarr;&nbsp;&nbsp;
                <a title="subscribe via RSS" class="social" href="http://feeds.feedburner.com/varunbpatil" target="_blank"><img src="/PNGs/rss.png" width="36px" /></a>
                <a title="subscribe via e-mail" class="social" href="http://feedburner.google.com/fb/a/mailverify?uri=varunbpatil&amp;loc=en_US" target="_blank"><img src="/PNGs/mail.png" width="36px" /></a>
                <a class="social" href="http://feeds.feedburner.com/varunbpatil" target="_blank"><img src="http://feeds.feedburner.com/~fc/varunbpatil?bg=BDBDBD&amp;fg=000000&amp;anim=0" height="29" width="88" style="border:0" alt="" /></a>
        </p>




        <p class="social">powered by &nbsp;&rarr;&nbsp;&nbsp;
        <a class="social" href="https://github.com/mojombo/jekyll"><span>jekyll</span></a>
        <a class="social" href="https://github.com/Shopify/liquid"><span>liquid</span></a>
        <a class="social" href="https://github.com/"><span>github</span></a>
        </p>
    </div>
</footer>

</div>
</body>
</html>

